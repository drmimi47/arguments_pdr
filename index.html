<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Experience</title>
  
  <!-- AR.js library for camera-based AR -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
  
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    .ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
    .instructions {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      text-align: center;
      font-size: 16px;
      max-width: 80%;
      pointer-events: auto;
    }
    .pulse-circle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      border: 3px solid rgba(255,255,255,0.8);
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      animation: pulse 2s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.6; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    .controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      pointer-events: auto;
    }
    .btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(0,0,0,0.8);
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .error {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.9);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 200;
      max-width: 80%;
      display: none;
    }
    .a-enter-vr { display: none !important; }
  </style>
</head>

<body>
  <div class="ui-overlay">
    <div class="instructions" id="instructions">
      Point camera not too close to object
    </div>
    <div class="pulse-circle" id="pulseCircle"></div>
    <div class="controls">
      <button class="btn" id="resetBtn" title="Reset">Reset</button>
    </div>
  </div>

  <div class="error" id="errorMsg">
    <h3>Camera Access Needed</h3>
    <p>Please allow camera access to use AR</p>
    <button onclick="location.reload()">Try Again</button>
  </div>

  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false;"
    vr-mode-ui="enabled: false">
    
    <a-camera look-controls-enabled="false" arjs-look-controls></a-camera>
    <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
    <a-light type="directional" position="0 5 2" intensity="1.0"></a-light>
    
    <a-entity id="arContent" visible="false" position="0 0 -3">
      <!-- First text -->
      <a-text id="mainText" value="To scan is to Exist." position="0 1 0" align="center" color="white" scale="1.15 1.15 1.15" material="shader: msdf; font: roboto;" visible="true"></a-text>
      <!-- Second text -->
      <a-text id="secondText" value="Object (noun)\nA material thing that can be seen and touched." position="0 1 0" align="center" color="white" scale="0.40 0.40 0.40" material="shader: msdf; font: roboto;" visible="false"></a-text>
      <!-- Third text -->
      <a-text id="thirdText" value="Are QR codes gates?" position="0 1 0" align="center" color="white" scale="0.40 0.40 0.40" material="shader: msdf; font: roboto;" visible="false"></a-text>
      <!-- Fourth to Eighth text -->
      <a-text id="fourthText" value="Public spaces and private interfaces." position="0 1 0" align="center" color="white" scale="0.40 0.40 0.40" material="shader: msdf; font: roboto;" visible="false"></a-text>
      <a-text id="fifthText" value="Convenience costs community." position="0 1 0" align="center" color="white" scale="0.40 0.40 0.40" material="shader: msdf; font: roboto;" visible="false"></a-text>
      <a-text id="sixthText" value="Touch the wax, feel the weight of exclusion." position="0 1 0" align="center" color="white" scale="0.40 0.40 0.40" material="shader: msdf; font: roboto;" visible="false"></a-text>
      <a-text id="seventhText" value="Design for all, not just the technology-enabled." position="0 1 0" align="center" color="white" scale="0.40 0.40 0.40" material="shader: msdf; font: roboto;" visible="false"></a-text>
      <a-text id="eighthText" value="End of transmission." position="0 1 0" align="center" color="white" scale="0.40 0.40 0.40" material="shader: msdf; font: roboto;" visible="false"></a-text>
    </a-entity>

    <a-plane id="tapTarget" position="0 0 -4" rotation="-90 0 0" width="100" height="100" material="opacity: 0; transparent: true" class="clickable"></a-plane>
  </a-scene>

  <script>
    let isARPlaced = false;
    let textAnimationComplete = false;

    document.querySelector('a-scene').addEventListener('loaded', function() {
      checkCameraPermission();
    });

    function checkCameraPermission() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showError('Camera not supported on this device');
        return;
      }
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
          stream.getTracks().forEach(track => track.stop());
        })
        .catch(function(error) {
          showError('Camera access denied');
        });
    }

    function showError(message) {
      const errorElement = document.getElementById('errorMsg');
      errorElement.querySelector('p').textContent = message;
      errorElement.style.display = 'block';
    }

    document.getElementById('tapTarget').addEventListener('click', function() {
      placeARContent();
    });

    let touchStartTime = 0;
    document.addEventListener('touchstart', function() {
      touchStartTime = Date.now();
    });
    document.addEventListener('touchend', function(event) {
      const touchDuration = Date.now() - touchStartTime;
      if (touchDuration < 300 && !isARPlaced) {
        placeARContent();
      }
    });

    function placeARContent() {
      if (isARPlaced) return;
      const arContent = document.getElementById('arContent');
      arContent.setAttribute('visible', 'true');
      document.getElementById('pulseCircle').style.display = 'none';
      isARPlaced = true;
      updateInstructions('Data unencrypted, Move your device to explore');
      startTextAnimation();
    }

    function startTextAnimation() {
      if (textAnimationComplete) return;

      const mainText = document.getElementById('mainText');
      const secondText = document.getElementById('secondText');
      const thirdText = document.getElementById('thirdText');
      const fourthText = document.getElementById('fourthText');
      const fifthText = document.getElementById('fifthText');
      const sixthText = document.getElementById('sixthText');
      const seventhText = document.getElementById('seventhText');
      const eighthText = document.getElementById('eighthText');

      let delay = 7000; // First switch

      setTimeout(() => { mainText.setAttribute('visible', 'false'); secondText.setAttribute('visible', 'true'); }, delay);
      delay += 5000;
      setTimeout(() => { secondText.setAttribute('visible', 'false'); thirdText.setAttribute('visible', 'true'); }, delay);
      delay += 5000;
      setTimeout(() => { thirdText.setAttribute('visible', 'false'); fourthText.setAttribute('visible', 'true'); }, delay);
      delay += 5000;
      setTimeout(() => { fourthText.setAttribute('visible', 'false'); fifthText.setAttribute('visible', 'true'); }, delay);
      delay += 5000;
      setTimeout(() => { fifthText.setAttribute('visible', 'false'); sixthText.setAttribute('visible', 'true'); }, delay);
      delay += 5000;
      setTimeout(() => { sixthText.setAttribute('visible', 'false'); seventhText.setAttribute('visible', 'true'); }, delay);
      delay += 5000;
      setTimeout(() => { seventhText.setAttribute('visible', 'false'); eighthText.setAttribute('visible', 'true'); textAnimationComplete = true; }, delay);
    }

    document.getElementById('resetBtn').addEventListener('click', function() {
      const arContent = document.getElementById('arContent');
      arContent.setAttribute('visible', 'false');
      document.getElementById('pulseCircle').style.display = 'block';

      const texts = ['mainText', 'secondText', 'thirdText', 'fourthText', 'fifthText', 'sixthText', 'seventhText', 'eighthText'];
      texts.forEach((id, index) => {
        document.getElementById(id).setAttribute('visible', index === 0);
      });

      isARPlaced = false;
      textAnimationComplete = false;
      updateInstructions('Point camera not too close to object');
    });

    function updateInstructions(text) {
      document.getElementById('instructions').textContent = text;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const experience = urlParams.get('experience');
    const qrId = urlParams.get('qr');
    if (qrId) { console.log('Launched from QR code:', qrId); }

    function customizeExperience() {
      const textLabel = document.getElementById('mainText');
      switch(experience) {
        case 'demo1':
          textLabel.setAttribute('value', 'Demo 1');
          textLabel.setAttribute('color', '#FF6B6B');
          updateInstructions('Demo 1: Point camera to find surfaces');
          break;
        case 'demo2':
          textLabel.setAttribute('value', 'Demo 2');
          textLabel.setAttribute('color', '#4ECDC4');
          updateInstructions('Demo 2: Point camera to find surfaces');
          break;
        case 'museum':
          textLabel.setAttribute('value', 'Museum Guide');
          textLabel.setAttribute('color', '#45B7D1');
          updateInstructions('Museum: Point camera to find surfaces');
          break;
      }
    }
    customizeExperience();

    window.addEventListener('error', function(event) {
      console.error('JavaScript error:', event.error);
    });
    window.addEventListener('orientationchange', function() {
      setTimeout(function() {
        window.location.reload();
      }, 500);
    });
  </script>
</body>
</html>
