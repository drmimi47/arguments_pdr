<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR Experience</title>
  
  <!-- AR.js library for camera-based AR - no registration needed -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js"></script>
  
  <style>
    /* ========================================
       BASIC PAGE SETUP
       ======================================== */
    /* Basic reset and font */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }

    /* ========================================
       UI OVERLAY - Elements on top of camera
       ======================================== */
    /* Container for all UI elements overlaid on camera */
    .ui-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* Let camera touches pass through */
      z-index: 100;
    }

    /* ========================================
       INSTRUCTION TEXT - Top of screen
       ======================================== */
    /* Instruction text at top of screen */
    .instructions {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 25px;
      text-align: center;
      font-size: 16px;
      max-width: 80%;
      pointer-events: auto; /* Allow interaction with this element */
    }

    /* ========================================
       SCANNING INDICATOR - Center target
       ======================================== */
    /* Scanning indicator in center of screen */
    .scanning-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120px;
      height: 120px;
      border: 3px solid rgba(255,255,255,0.8);
      border-radius: 15px;
      background: rgba(255,255,255,0.1);
      animation: scan 2s ease-in-out infinite;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: white;
      text-align: center;
    }

    /* Animation for scanning effect */
    @keyframes scan {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.1);
        opacity: 0.7;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    /* Control buttons at bottom */
    .controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      pointer-events: auto; /* Allow button clicks */
    }

    /* Individual reset button styling */
    .btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(0,0,0,0.8);    
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    /* ========================================
       ERROR MESSAGES - Camera issues
       ======================================== */
    /* Error message if camera fails */
    .error {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.9);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 200;
      max-width: 80%;
      display: none; /* Hidden by default */
    }

    /* ========================================
       HIDE DEFAULT A-FRAME ELEMENTS
       ======================================== */
    /* Hide A-Frame's default VR button */
    .a-enter-vr {
      display: none !important;
    }

    /* Status indicator for marker detection */
    .marker-status {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 14px;
      display: none;
    }
  </style>
</head>

<body>
  <!-- UI Layer - overlaid on top of camera view -->
  <div class="ui-overlay">
          <!-- Instructions that change based on state -->
    <div class="instructions" id="instructions">
      Point camera at QR code or printed marker
    </div>
    
    <!-- Scanning indicator in center (hidden after QR is found) -->
    <div class="scanning-indicator" id="scanningIndicator">
      Scan QR Code
    </div>
    
    <!-- Marker detection status -->
    <div class="marker-status" id="markerStatus">
      QR Code Detected
    </div>
    
    <!-- Control buttons -->
    <div class="controls">
      <button class="btn" id="resetBtn" title="Reset">Reset</button>
    </div>
  </div>

  <!-- Error message for camera issues -->
  <div class="error" id="errorMsg">
    <h3>Camera Access Needed</h3>
    <p>Please allow camera access to use AR</p>
    <button onclick="location.reload()">Try Again</button>
  </div>

  <!-- A-Frame AR Scene with image marker tracking -->
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; trackingMethod: best;"
    vr-mode-ui="enabled: false">
    
    <!-- Camera setup -->
    <a-camera look-controls-enabled="false" arjs-look-controls></a-camera>
    
    <!-- Lighting for 3D objects -->
    <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
    <a-light type="directional" position="0 3 2" intensity="1.0"></a-light>
    
    <!-- Marker entity - AR content will be anchored to this -->
    <a-nft 
      id="markerEntity"
      type="nft" 
      url="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/examples/marker-training/examples/pattern-files/pattern-letterA"
      smooth="true" 
      smoothCount="10" 
      smoothTolerance="0.01" 
      smoothThreshold="5"
      raycaster="objects: .clickable">
      
      <!-- AR Content Group - positioned relative to marker -->
      <a-entity id="arContent" position="0 0 0">
        
        <!-- Initial text that will fade out -->
        <a-text 
          id="mainText"
          value="To scan is to Exist." 
          position="0 1 0" 
          align="center" 
          color="white" 
          scale="1.5 1.5 1.5"
          material="shader: msdf; font: roboto;"
          visible="true">
        </a-text>
        
        <!-- Second text that will appear after fade -->
        <a-text 
          id="secondText"
          value="Object (noun)\nA material thing that can be seen and touched." 
          position="0 1 0" 
          align="center" 
          color="white" 
          scale="0.6 0.6 0.6"
          material="shader: msdf; font: roboto;"
          visible="false">
        </a-text>
        
        <!-- 3rd text that will appear after fade -->
        <a-text 
          id="thirdText"
          value="[work in progress...]" 
          position="0 1 0" 
          align="center" 
          color="white" 
          scale="0.6 0.6 0.6"
          material="shader: msdf; font: roboto;"
          visible="false">
        </a-text>

        <!-- Optional: Add a visual base/platform -->
        <a-cylinder 
          position="0 0.1 0" 
          radius="1" 
          height="0.2" 
          color="#333333" 
          opacity="0.3">
        </a-cylinder>

      </a-entity>
    </a-nft>

    <!-- Fallback: If NFT fails, use pattern marker -->
    <a-marker 
      id="fallbackMarker"
      type="pattern" 
      url="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/three.js/examples/marker-training/examples/pattern-files/pattern-hiro.patt"
      smooth="true" 
      smoothCount="10" 
      smoothTolerance="0.01" 
      smoothThreshold="5"
      visible="false">
      
      <!-- Duplicate AR content for fallback -->
      <a-entity position="0 0 0">
        <a-text 
          value="Fallback Mode - Use Hiro Marker" 
          position="0 1 0" 
          align="center" 
          color="yellow" 
          scale="1.0 1.0 1.0">
        </a-text>
      </a-entity>
    </a-marker>
  </a-scene>

  <script>
    // ===========================================
    // GLOBAL VARIABLES
    // ===========================================
    let markerFound = false;           // Track if marker is currently visible
    let textAnimationStarted = false;  // Track if text animation has started
    let textAnimationComplete = false; // Track if text animation has completed

    // ===========================================
    // INITIALIZATION
    // ===========================================
    
    // Wait for the AR scene to fully load
    document.querySelector('a-scene').addEventListener('loaded', function() {
      console.log('AR scene loaded successfully');
      checkCameraPermission();
      setupMarkerEvents();
    });

    // ===========================================
    // MARKER TRACKING EVENTS
    // ===========================================
    
    function setupMarkerEvents() {
      const marker = document.getElementById('markerEntity');
      const fallbackMarker = document.getElementById('fallbackMarker');
      
      // Function to handle marker found
      function handleMarkerFound(markerType) {
        console.log(`${markerType} marker detected!`);
        markerFound = true;
        
        // Hide scanning indicator
        document.getElementById('scanningIndicator').style.display = 'none';
        
        // Show marker status
        const markerStatus = document.getElementById('markerStatus');
        markerStatus.style.display = 'block';
        markerStatus.textContent = `${markerType} detected - Move device to explore`;
        
        // Update instructions
        updateInstructions(`${markerType} detected! Move your device around`);
        
        // Start text animation if not already started
        if (!textAnimationStarted) {
          startTextAnimation();
        }
      }
      
      // Function to handle marker lost
      function handleMarkerLost(markerType) {
        console.log(`${markerType} marker lost`);
        markerFound = false;
        
        // Show scanning indicator again
        document.getElementById('scanningIndicator').style.display = 'flex';
        
        // Hide marker status
        document.getElementById('markerStatus').style.display = 'none';
        
        // Update instructions
        updateInstructions('Point camera back at QR code or marker');
      }
      
      // Primary marker events (NFT - for your QR code)
      marker.addEventListener('markerFound', () => handleMarkerFound('QR Code'));
      marker.addEventListener('markerLost', () => handleMarkerLost('QR Code'));
      
      // Fallback marker events (Pattern marker)
      fallbackMarker.addEventListener('markerFound', () => {
        handleMarkerFound('Pattern');
        fallbackMarker.setAttribute('visible', 'true');
      });
      fallbackMarker.addEventListener('markerLost', () => {
        handleMarkerLost('Pattern');
        fallbackMarker.setAttribute('visible', 'false');
      });
    }

    // ===========================================
    // CAMERA PERMISSION CHECK
    // ===========================================
    
    function checkCameraPermission() {
      // Test if camera is available
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showError('Camera not supported on this device');
        return;
      }

      // Request camera access
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
          console.log('Camera permission granted');
          // Stop the test stream immediately
          stream.getTracks().forEach(track => track.stop());
        })
        .catch(function(error) {
          console.error('Camera permission denied:', error);
          showError('Camera access denied');
        });
    }

    function showError(message) {
      const errorElement = document.getElementById('errorMsg');
      errorElement.querySelector('p').textContent = message;
      errorElement.style.display = 'block';
    }

    // ===========================================
    // TEXT ANIMATION SYSTEM
    // ===========================================
    
    function startTextAnimation() {
      if (textAnimationStarted) return; // Don't run animation twice
      
      textAnimationStarted = true;
      
      const mainText = document.getElementById('mainText');
      const secondText = document.getElementById('secondText');
      const thirdText = document.getElementById('thirdText');
      
      console.log('Starting text animation sequence...');
      
      // Step 1: After 5 seconds, hide first text and show second text
      setTimeout(() => {
        console.log('Step 1: Switching from first text to second text');
        mainText.setAttribute('visible', 'false');
        secondText.setAttribute('visible', 'true');
      }, 5000); // Wait 5 seconds before switching to second text
      
      // Step 2: After another 5 seconds, hide second text and show third text
      setTimeout(() => {
        console.log('Step 2: Switching from second text to third text');
        secondText.setAttribute('visible', 'false');
        thirdText.setAttribute('visible', 'true');
        
        textAnimationComplete = true;
        console.log('Text animation sequence completed');
      }, 10000); // Wait total of 10 seconds before switching to third text
    }

    // ===========================================
    // UI CONTROLS
    // ===========================================
    
    // Reset button - reset the experience
    document.getElementById('resetBtn').addEventListener('click', function() {
      // Reset text states
      const mainText = document.getElementById('mainText');
      const secondText = document.getElementById('secondText');
      const thirdText = document.getElementById('thirdText');
      
      // Reset visibility states to initial conditions
      mainText.setAttribute('visible', 'true');
      secondText.setAttribute('visible', 'false');
      thirdText.setAttribute('visible', 'false');
      
      // Reset animation states
      textAnimationStarted = false;
      textAnimationComplete = false;
      
      // Reset UI
      if (!markerFound) {
        document.getElementById('scanningIndicator').style.display = 'flex';
        updateInstructions('Point camera at QR code');
      } else {
        updateInstructions('QR Code detected! Move your device around');
      }
      
      console.log('Experience reset');
    });

    function updateInstructions(text) {
      document.getElementById('instructions').textContent = text;
    }

    // ===========================================
    // QR CODE CUSTOMIZATION
    // ===========================================
    
    // Read URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const experience = urlParams.get('experience'); // e.g., ?experience=demo1
    const qrId = urlParams.get('qr');               // e.g., &qr=location1
    
    // Log QR code info for analytics
    if (qrId) {
      console.log('Launched from QR code:', qrId);
    }
    
    // Customize content based on experience parameter
    function customizeExperience() {
      const textLabel = document.getElementById('mainText');
      
      // ==========================================
      // QR CODE CUSTOMIZATION - Different experiences
      // ==========================================
      
      switch(experience) {
        case 'demo1':
          textLabel.setAttribute('value', 'Demo 1: AR Locked');
          textLabel.setAttribute('color', '#FF6B6B'); // Red text
          break;
          
        case 'demo2':
          textLabel.setAttribute('value', 'Demo 2: AR Locked');
          textLabel.setAttribute('color', '#4ECDC4'); // Teal text
          break;
          
        case 'museum':
          textLabel.setAttribute('value', 'Museum Guide AR');
          textLabel.setAttribute('color', '#45B7D1'); // Blue text
          break;
          
        default:
          // Keep default text and color
          break;
      }
    }

    // Apply customization when page loads
    customizeExperience();

    // ===========================================
    // ERROR HANDLING & UTILITIES
    // ===========================================
    
    // Handle JavaScript errors
    window.addEventListener('error', function(event) {
      console.error('JavaScript error:', event.error);
    });

    // Handle orientation changes on mobile
    window.addEventListener('orientationchange', function() {
      setTimeout(function() {
        console.log('Orientation changed, reloading...');
        window.location.reload();
      }, 500);
    });

    // ===========================================
    // DEBUG HELPERS
    // ===========================================
    
    console.log('=== Multi-Marker AR Experience Debug Info ===');
    console.log('Experience type:', experience || 'default');
    console.log('QR source:', qrId || 'direct access');
    console.log('Primary: NFT marker (your QR code)');
    console.log('Fallback: Hiro pattern marker');
    console.log('============================================');
  </script>
</body>
</html>